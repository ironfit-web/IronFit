<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IronFit - Ø§Ù„Ù…ØªØ¬Ø±</title>
  <link rel="stylesheet" href="../../CSS/index.css">
</head>
<body>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
 <div id="sidebar" class="sidebar">
  <button onclick="window.location.href='../Login-Html/login.html'" class="login-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  <button onclick="window.location.href='help.html'" class="help">
    Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ¯Ø¹Ù…
  </button>
</div>


<!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
<header>
  <div class="top-bar">
    <button id="menuBtn" class="menu-btn">â˜°</button>

    <div class="search">
      <input id="search" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ù„ÙˆØµÙ..." />
    </div>
  </div>

  <nav class="categories" id="categories"></nav>
</header>

<!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
<div id="productsGrid" class="grid"></div>

<script>
// ========== Ù†ÙØ³ Ø§Ù„Ø³ÙƒØ±Ø¨Øª ØªØ§Ø¹Ùƒ Ø¨Ù„Ø§ ØªØºÙŠÙŠØ± ÙƒØ¨ÙŠØ± ==========
const $ = sel => document.querySelector(sel);
const productsGrid = $('#productsGrid');
const categoriesContainer = $('#categories');
const searchInput = $('#search');

let PRODUCTS = [];
let CATEGORIES = [];
let activeCategory = '';

function escapeHtml(s) {
  if (!s) return '';
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
  }[m]));
}

async function fetchCategories() {
  try {
    const res = await fetch('/categories');
    if(!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª');
    CATEGORIES = await res.json();
    renderCategories();
  } catch(e) { console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª', e); }
}

function renderCategories() {
  categoriesContainer.innerHTML = '';

  const allLink = document.createElement('a');
  allLink.textContent = 'Ø§Ù„ÙƒÙ„ ';
  allLink.className = activeCategory === '' ? 'category-link active' : 'category-link';
  allLink.href = "#";
  allLink.addEventListener('click', (e) => {
    e.preventDefault();
    activeCategory = '';
    renderProducts(PRODUCTS);
    renderCategories();
  });
  categoriesContainer.appendChild(allLink);

  CATEGORIES.forEach(c => {
    const link = document.createElement('a');
    link.textContent = escapeHtml(c.name);
    link.href = "#";
    link.className = activeCategory === String(c.id) ? 'category-link active' : 'category-link';
    link.addEventListener('click', (e) => {
      e.preventDefault();
      activeCategory = String(c.id);
      renderProducts(PRODUCTS);
      renderCategories();
    });
    categoriesContainer.appendChild(link);
  });
}

async function fetchProducts() {
  try {
    const res = await fetch('/products');
    if(!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
    PRODUCTS = await res.json();
    renderProducts(PRODUCTS);
  } catch (err) {
    console.error(err);
    productsGrid.innerHTML = '<div>âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>';
  }
}

// ... (Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰) ...

function renderProducts(list) {
  let filtered = list;
  if(activeCategory) filtered = filtered.filter(p => String(p.category_id) === activeCategory);
  const query = searchInput.value.trim().toLowerCase();
  if(query) filtered = filtered.filter(p => (p.name||'').toLowerCase().includes(query) || (p.description||'').toLowerCase().includes(query));

  productsGrid.innerHTML = '';
  if(!filtered.length) {
    productsGrid.innerHTML = '<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§</div>';
    return;
  }

  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØºÙŠØ± Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„ÙƒÙ„ Ø¨Ø·Ø§Ù‚Ø©
  let delay = 0.1; // ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ£Ø®ÙŠØ± Ù…Ù† 0.1 Ø«Ø§Ù†ÙŠØ©

  filtered.forEach((p, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    const imgSrc = (p.image && p.image !== 'null') ? p.image : 'https://via.placeholder.com/400x300?text=No+Image';

    card.innerHTML = `
      <img src="${escapeHtml(imgSrc)}" alt="${escapeHtml(p.name)}" class="thumb">
      <div class="meta">
        <div class="title">${escapeHtml(p.name)}</div>
        <div class="desc">${escapeHtml(p.description || '').slice(0,50)}${p.description && p.description.length>50?'...':''}</div>
        <div class="price">${Number(p.price).toLocaleString()} DA</div>
        <div class="category">${escapeHtml(p.category_name || '')}</div>
      </div>
    `;

    card.addEventListener('click', () => {
      window.location.href = `product.html?id=${p.id}`;
    });

    // ğŸ‘ˆ [Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© 1] ØªØ¹ÙŠÙŠÙ† Ø®Ø§ØµÙŠØ© CSS Ù…Ø®ØµØµØ© Ù„Ù„ØªØ£Ø®ÙŠØ± 
    // ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ù…ØªØ²Ø§ÙŠØ¯ (0.1s, 0.2s, 0.3s, ÙˆÙ‡ÙƒØ°Ø§)
    card.style.setProperty('--animation-delay', `${delay * (index + 1)}s`);
    // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© Ø£Ø¨Ø³Ø·:
    // card.style.animationDelay = `${delay * (index + 1)}s`; 

    productsGrid.appendChild(card);
  });
}

// ... (Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„) ...

searchInput.addEventListener('input', () => renderProducts(PRODUCTS));

fetchCategories().then(fetchProducts);

// Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
const menuBtn = document.getElementById('menuBtn');
const sidebar = document.getElementById('sidebar');

menuBtn.addEventListener('click', () => {
  sidebar.classList.toggle('open');
});

document.addEventListener('click', (e) => {
  if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
    sidebar.classList.remove('open');
  }
});
</script>

</body>
</html>