<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../../CSS/Admin-Css/products-admin.css">
<title>لوحة الإدارة</title>

</head>
<body>
<h1>لوحة الإدارة</h1>

<!-- التنقل -->
<div class="nav">
  <button data-tab="products" class="active">🛒 المنتجات</button>
  <button data-tab="categories">🏷️ التصنيفات</button>
</div>

<div id="message" class="msg"></div>

<!-- قسم المنتجات -->
<section id="products" class="active">
  <div class="top" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
    <input id="search" type="search" placeholder="ابحث باسم المنتج أو الوصف...">
    <select id="filterCategory"><option value="">كل التصنيفات</option></select>
    <button id="openAdd" class="primary">+ إضافة منتج</button>
  </div>
  <div id="productsGrid" class="grid"></div>
</section>

<!-- قسم التصنيفات -->
<section id="categories">
  <h2>إدارة التصنيفات</h2>
  <form id="catForm" style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;">
    <input id="catName" placeholder="اسم التصنيف الجديد">
    <button class="primary">إضافة</button>
  </form>
  <div id="categoriesList" class="cat-list"></div>
</section>

<!-- مودال إضافة -->
<div id="addModal" class="modal">
  <div class="box">
    <h3>إضافة منتج</h3>
    <form id="addForm">
      <input name="image" type="file">
      <input name="name" placeholder="اسم المنتج *">
      <textarea name="description" rows="3" placeholder="الوصف"></textarea>
      <input name="price" type="number" placeholder="السعر *">
      <select name="category_id" id="addCategory"><option value="">اختر التصنيف</option></select>
      <div style="text-align:end;">
        <button type="button" data-close>إلغاء</button>
        <button class="primary">حفظ</button>
      </div>
    </form>
  </div>
</div>

<!-- مودال تعديل -->
<div id="editModal" class="modal">
  <div class="box">
    <h3>تعديل المنتج</h3>
    <div class="small" id="editIdLabel"></div>
    <form id="editForm">
      <input name="image" type="file">
      <input name="name" placeholder="اسم المنتج *">
      <textarea name="description" rows="3" placeholder="الوصف"></textarea>
      <input name="price" type="number" placeholder="السعر *">
      <select name="category_id" id="editCategory"><option value="">اختر التصنيف</option></select>
      <div style="text-align:end;">
        <button type="button" data-close>إلغاء</button>
        <button class="primary">تحديث</button>
      </div>
    </form>
  </div>
</div>

<script>
// نفس سكريبتك الأصلي مع إضافة تبويبات
const $=s=>document.querySelector(s);
let PRODUCTS=[],FILTERED=[],editingId=null;
const msgBox=$('#message');

function showMsg(txt,ok=true,time=2500){
  msgBox.textContent=txt;
  msgBox.className='msg '+(ok?'ok':'err');
  msgBox.style.display='block';
  if(time)setTimeout(()=>msgBox.style.display='none',time);
}

// APIs
async function apiFetchProducts(){ const res=await fetch('/products'); if(!res.ok) throw new Error('فشل جلب المنتجات'); return res.json(); }
async function apiDeleteProduct(id){ return fetch(`/products/${id}`,{method:'DELETE'}); }
async function apiUpdateProduct(id,fd){ return fetch(`/products/${id}`,{method:'PUT',body:fd}); }
async function apiCreateProduct(fd){ return fetch('/products',{method:'POST',body:fd}); }
async function apiFetchCategories(){ const res=await fetch('/categories'); if(!res.ok) throw new Error('فشل جلب التصنيفات'); return res.json(); }
async function apiCreateCategory(name){ const res=await fetch('/categories',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})}); if(!res.ok) throw new Error('فشل إضافة التصنيف'); return res.json(); }
async function apiUpdateCategory(id,name){ const res=await fetch(`/categories/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})}); if(!res.ok) throw new Error('فشل تحديث التصنيف'); return res.json(); }
async function apiDeleteCategory(id){ const res=await fetch(`/categories/${id}`,{method:'DELETE'}); if(!res.ok) throw new Error('فشل حذف التصنيف'); return res; }

// Render
function renderProducts(){
  const c=$('#productsGrid');c.innerHTML='';
  if(!FILTERED.length){c.innerHTML='<div style="grid-column:1/-1;color:#666;">لا توجد منتجات</div>';return;}
  for(const p of FILTERED){
    c.insertAdjacentHTML('beforeend',`<div class="card">
      <img class="thumb" src="${p.image||'https://via.placeholder.com/90?text=No+Image'}">
      <div class="meta">
        <h3>${escapeHtml(p.name)}</h3>
        <p>${escapeHtml(p.description||'')}</p>
        <div class="price">${Number(p.price).toLocaleString()} دج</div>
        <div class="small">${escapeHtml(p.category_name||'')}</div>
        <div class="actions">
          <button class="edit" data-id="${p.id}">✏️ تعديل</button>
          <button class="danger delete" data-id="${p.id}">🗑️ حذف</button>
        </div>
      </div>
    </div>`);
  }
}
function renderCategories(cats){
  const box=$('#categoriesList'); box.innerHTML='';
  if(!cats.length){box.innerHTML='<div style="color:#666;">لا توجد تصنيفات</div>';return;}
  for(const c of cats){
    box.insertAdjacentHTML('beforeend',`
      <div class="cat-item">
        <span>${escapeHtml(c.name)}</span>
        <div class="cat-actions">
          <button class="edit" data-id="${c.id}" data-name="${c.name}">✏️ تعديل</button>
          <button class="danger delete" data-id="${c.id}">🗑️ حذف</button>
        </div>
      </div>
    `);
  }
  // events
  box.querySelectorAll('.delete').forEach(b=>b.onclick=async()=>{
    if(!confirm('تأكيد الحذف؟')) return;
    try{await apiDeleteCategory(b.dataset.id);showMsg('🗑️ تم حذف التصنيف'); loadCategories();}
    catch(e){showMsg('❌ '+e.message,false);}
  });
  box.querySelectorAll('.edit').forEach(b=>b.onclick=async()=>{
    const newName=prompt('اسم جديد للتصنيف:',b.dataset.name);
    if(!newName) return;
    try{await apiUpdateCategory(b.dataset.id,newName);showMsg('✅ تم التحديث'); loadCategories();}
    catch(e){showMsg('❌ '+e.message,false);}
  });
}

// Events
$('#productsGrid').addEventListener('click',async e=>{
  const id=e.target.dataset.id;
  if(e.target.classList.contains('delete')){
    if(!confirm('تأكيد الحذف؟')) return;
    try{await apiDeleteProduct(id);showMsg('🗑️ تم الحذف'); init();}
    catch(err){showMsg('❌ '+err.message,false);}
  }
  if(e.target.classList.contains('edit')){
    const p=PRODUCTS.find(x=>x.id==id);
    if(!p)return;
    editingId=id;
    $('#editIdLabel').textContent='ID: '+id;
    const f=$('#editForm');
    f.name.value=p.name; f.description.value=p.description||''; f.price.value=p.price||0; f.category_id.value=p.category_id||'';
    $('#editModal').style.display='grid';
  }
});
$('#addForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  try{await apiCreateProduct(fd);showMsg('✅ تم الإضافة');$('#addModal').style.display='none';e.target.reset();init();}
  catch(err){showMsg('❌ '+err.message,false);}
});
$('#editForm').addEventListener('submit',async e=>{
  e.preventDefault();
  if(!editingId) return;
  const fd=new FormData(e.target);
  try{await apiUpdateProduct(editingId,fd);showMsg('✅ تم التحديث');$('#editModal').style.display='none';init();}
  catch(err){showMsg('❌ '+err.message,false);}
});
$('#catForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const name=$('#catName').value.trim();
  if(!name) return;
  try{await apiCreateCategory(name);showMsg('✅ تم الإضافة');$('#catName').value='';loadCategories();}
  catch(err){showMsg('❌ '+err.message,false);}
});
$('#search').addEventListener('input',()=>filterRender());
$('#filterCategory').addEventListener('change',()=>filterRender());
function filterRender(){
  const q=$('#search').value.trim().toLowerCase();
  const catId=$('#filterCategory').value;
  FILTERED=PRODUCTS.filter(p=>{
    const matchText=(p.name||'').toLowerCase().includes(q)||(p.description||'').toLowerCase().includes(q);
    const matchCat=!catId||p.category_id==catId;
    return matchText&&matchCat;
  });
  renderProducts();
}
function escapeHtml(str){return (str||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}
async function init(){
  try{
    PRODUCTS=await apiFetchProducts();
    FILTERED=[...PRODUCTS];
    renderProducts();
    loadCategories();
  }catch(e){showMsg('❌ '+e.message,false);}
}
async function loadCategories(){
  try{
    const cats=await apiFetchCategories();
    renderCategories(cats);
    const add=$('#addCategory'),edit=$('#editCategory'),filter=$('#filterCategory');
    add.innerHTML='<option value="">اختر التصنيف</option>';
    edit.innerHTML='<option value="">اختر التصنيف</option>';
    filter.innerHTML='<option value="">كل التصنيفات</option>';
    for(const c of cats){
      const opt=`<option value="${c.id}">${escapeHtml(c.name)}</option>`;
      add.insertAdjacentHTML('beforeend',opt);
      edit.insertAdjacentHTML('beforeend',opt);
      filter.insertAdjacentHTML('beforeend',opt);
    }
  }catch(e){showMsg('❌ فشل جلب التصنيفات',false);}
}
document.querySelectorAll('[data-close]').forEach(b=>b.onclick=()=>b.closest('.modal').style.display='none');
$('#openAdd').onclick=()=>$('#addModal').style.display='grid';

// ✅ التبويبات
document.querySelectorAll('.nav button').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('section').forEach(sec=>sec.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
  };
});

init();
</script>
</body>
</html>
